{% extends "base.html" %}
{% load static %}


{% block title %}Feed{% endblock %}

{% block content %}

{{ id|json_script:"room-id" }}

<div class="container-fluid">
    <div class="body-chat">

        <!-- Sidebar -->
        <div class=" sidebar" >
            <div class="user-list">
                <h2>Usu√°rios Online</h2>
                <div class="card-body" id="user-list">
                </div>
            </div>
        </div>



        <div class="chat-container">
            <h2>Chat Room</h2>
            <div class="chat-header">
                <p class="text-muted">Sala criada por @{{host}}</p>
            </div>
            <div class="chat-messages" id="chat-log">
                <div class="message received">
                    <strong>{{host}}</strong><br>
                    Hello! How are you?
                    <span class="meta">10:32</span>
                </div>
                <div class="message sent">
                    <strong>You</strong><br>
                    I'm good, thanks! And you?
                    <span class="meta">10:33</span>
                </div>
            </div>
            <div class="chat-input">
                <input id="chat-message-input" type="text" placeholder="Type a message..." />
                <button id="chat-message-submit" value="Send"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
</div>

<script>
    let ngrok_url = ""

    const roomId = JSON.parse(document.getElementById('room-id').textContent);

    // const chatSocket = new WebSocket(
    //     'wss://' + `${ngrok_url} + '/ws/chat/` + roomId + '/'
    // );

    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        if (data.type === "chat") {
            t_ms = "received"
            if (data.is_from_me == true) {
                t_ms = "sent"
            }
            newChat = `<div class="message ${t_ms}">
                            <strong>${data.username}</strong><br>
                            ${data.message}
                            <span class="meta">19:00</span>
                        </div>`

            // Insert into the chat container
            document.querySelector("#chat-log").insertAdjacentHTML("beforeend", newChat);

        } else if (data.type === "users") {
            const list = document.getElementById("user-list");

            if (!list) return;

            // Clear the current list
            list.innerHTML = "";

            // Create and insert the updated user list
            const newList = data.users
                .map(u => `<div class="user">
                                <span>
                                    <img src="{% static 'img/default_profile.png' %}" 
                                    class="rounded-circle me-3" 
                                    width="50" 
                                    height="50" alt="Image">
                                    ${u}
                                </span>
                            </div>`).join('');


            list.insertAdjacentHTML("beforeend", newList);
        }


    };
    // Auto scroll to bottom
    document.querySelector("#chat-log").scrollTop = document.querySelector("#chat-log").scrollHeight;

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly', e);
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.key === 'Enter') { 
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));
        messageInputDom.value = '';
    };
</script>

{% endblock %}